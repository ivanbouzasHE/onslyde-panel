/*! onslyde - v0.0.1 - 2014-09-13
* Copyright (c) 2014 Wesley Hales; Licensed  */
!function(a,b){"use strict";a.onslyde=function(){var c,d=function(a){return c=a,new d.core.init},e={sessionID:0,mode:"default"},f={sessionID:0,mode:"default"},g=0;d.core=d.prototype={constructor:d,start:function(){try{c&&(e=null!==c.panel?c.panel:null,f=null!==c.panelRemote?c.panelRemote:null)}catch(a){}d.core.hideURLBar(),e&&e.sessionID&&(g=e.sessionID,d.panel.init()),f&&f.sessionID&&(g=f.sessionID)},hideURLBar:function(){setTimeout(a.scrollTo,0,0,1)},init:function(){return a.addEventListener("load",function(){d.core.start()},!1),d.core},ajax:function(b,c,d){function e(){return a.XMLHttpRequest?new XMLHttpRequest:a.ActiveXObject?new a.ActiveXObject("Microsoft.XMLHTTP"):void 0}function f(){4===g.readyState&&200===g.status&&c&&c(g.responseText,b)}var g=e();g.onreadystatechange=f,this.doGet=function(){g.open("GET",b,d),g.send(null)},this.doPost=function(a){g.open("POST",b,d),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send(a)}}},d.core.init.prototype=d.core;var h,i,j=null,k=!1;d.ws=d.prototype={ip:function(a){var b;b=location.host.indexOf("onslyde.com")>=0?"https://www.onslyde.com:8443":"https://127.0.0.1:8443";new d.core.ajax(b+"/go/presenters/ip?session="+a,function(a){j="onslyde.com"===location.host?"www.onslyde.com":a},!1);return j=null===j&&"file:"!==location.protocol&&"localhost:8001"!==location.host?"www.onslyde.com":"www.onslyde.com"},getip:function(){var a,b=function(){return Math.floor(Math.random()*(d-c+1))+c},c=255,d=999;if(localStorage["onslyde.attendeeIP"])a=localStorage["onslyde.attendeeIP"];else{a=b()+"."+b()+"."+b()+"."+b();try{localStorage["onslyde.attendeeIP"]=a}catch(e){}}return a},sessionID:function(){return g},connect:function(a,b,c){if(i="anonymous",a)this.getip(),h=a;else{j||(j=this.ip(c));var e="wss://"+j+"/ws/?session="+c+"&attendeeIP="+this.getip();h=new WebSocket(e)}return h.onopen=function(){k=!0,"undefined"!=typeof b&&d.ws._send(b)},h.onmessage=this._onmessage,h.onclose=this._onclose,h.sendText=function(a){d.ws._send(a)},h},_onmessage:function(a){if(a.data)if("object"==typeof a.data)0!==a.data.onslydeEvent.sessionID&&a.data.onslydeEvent.fire();else if(a.data.indexOf('sessionID":"'+g)>0)try{var b=a.data;b=new Function("return "+b)(),b.onslydeEvent.fire()}catch(c){console.log(c)}},_onclose:function(){console.log("close it"),h=null},_onerror:function(){},_send:function(a){!h||h&&3===h.readyState?(console.log("connection closed... attempting reconnect"),this.connect(null,a,g)):h.send(a)}};var l,m,n,o,p,q=[],r=0,s=0,t=0,u=[],v=[],w=!0,x={agree:0,disagree:0},y=!1,z=0,A=b.querySelector("#continuousfloortime > span"),B=(b.querySelector("#totalfloortime > span"),b.querySelector("#contributions > span"),null);return d.panel=d.prototype={init:function(){function c(a){var c=b.getElementById(a);x[a]++,v.push({time:new Date,type:a}),d.panel.drawSentimentChart(),c&&(c.className="show-"+a+" transition",setTimeout(function(){c.className="hide-"+a+" transition"},800))}function e(a){for(var b=0;b<v.length;b++)a-v[b].time>15e3&&(x[v[b].type]--,v.splice(b,1),d.panel.drawSentimentChart())}a.addEventListener("clientVote",function(a){d.panel.optionVote(a.vote,l)},!1),a.addEventListener("updateCount",function(a){d.panel.updateDeck(a.wsCount,a.pollCount)},!1),a.addEventListener("speak",function(a){var b=JSON.parse(a.attendee);try{""!==b.name&&d.panel.queueSpeaker(b,a.ip)}catch(c){console.log("problem queueing speaker:",c)}},!1),a.addEventListener("disagree",function(){c("disagree")},!1),a.addEventListener("agree",function(){c("agree")},!1),a.addEventListener("questionToggle",function(){d.panel.questionToggle()},!1),a.addEventListener("questionIndex",function(a){z=a.index||"0",z=parseInt(z,10),d.panel.questionIndex(z)},!1);var f=b.getElementById("timer"),h=new Date;setInterval(function(){var a=new Date;w&&e(a),f.innerHTML=d.panel.countUpTimer(h,a)},1e3),o="activeOptions:null,null,Discussion",this.connect("::connect::"),setTimeout(function(){d.panel.updateRemotes()},1e3),b.getElementById("sessionID").innerHTML=this.calculateConnectString(g),p=b.querySelector(".queue-title"),p.style.display="none",this.drawSentimentChart()},countUpTimer:function(a,b){var c=b-a,d=Math.floor(c/36e5),e=Math.floor(c%36e5/6e4),f=Math.floor(c%36e5%6e4/1e3);return d=(10>d?"0":"")+d,e=(10>e?"0":"")+e,f=(10>f?"0":"")+f,d+":"+e+":"+f},setFloorTime:function(){console.log("set floor time"),B&&clearInterval(B);var a=new Date;B=setInterval(function(){var b=new Date;A.innerHTML=d.panel.countUpTimer(a,b)},1e3)},calculateConnectString:function(a){for(var b=["x","b","z","d","y","f","r","h","s","j"],c=a.toString().split(""),d="",e=0;e<c.length;e++)d+=b[c[e]];return d},connect:function(a){try{h?d.ws._send(a,g):d.ws.connect(null,a,g)}catch(b){console.log("error",b)}},questionToggle:function(){var a=b.getElementById("question-container");a.style.display="none"===a.style.display?"block":"none"},questionIndex:function(){for(var a=b.querySelectorAll("#question-container li"),c=0;c<a.length;c++)a[c].style.display=c!==z?"none":"block"},toggleConnectInfo:function(){y?(b.getElementById("panel-container").className="",b.getElementById("modal").className="",y=!1):(b.getElementById("panel-container").className="blur",b.getElementById("modal").className="visible",b.getElementById("modal-connect-string").innerHTML=b.querySelector(".connect-url").innerHTML,y=!0)},toggleRollingAverage:function(){w=!w,w?(b.querySelector(".sentiment-bar1").style.borderRightColor="#777",b.querySelector(".sentiment-bar2").style.borderLeftColor="#777"):(b.querySelector(".sentiment-bar1").style.borderRightColor="#000",b.querySelector(".sentiment-bar2").style.borderLeftColor="#000")},updateDeck:function(a,c){var d=b.getElementById("totalCount");m=a,n=c,d.innerHTML=parseInt(a,10)+parseInt(c,10)},createSpeakerNode:function(a,c,d){a.name=a.name||a.FirstName+" "+a.Surname;var e=b.createDocumentFragment();e.appendChild(b.getElementById("speaker-template").cloneNode(!0));var f=e.querySelector("img");f.src=a.pic,f.onclick=function(){d(a,c)},e.querySelector(".name").innerHTML=a.name;try{var g=getAttendees();if("[object Array]"===Object.prototype.toString.call(g))for(var h=0,i=g.length;i>h;h++){var j=g[h],k=j.FirstName+" "+j.Surname;if(a.name===k){a.org=j.Company;break}if(a.email===j.Email){a.org=j.Company;break}a.org=""}}catch(l){console.log("fix this")}return e.querySelector(".org").innerHTML=a.org,e},queueSpeaker:function(a,c,e){var f=!1;if(!e){for(var g=0,h=u.length;h>g;g++)if(u[g].speaker.email===a.email){f=!0;break}f||u.push({speaker:a,ip:c})}f?d.panel.removeSpeakerFromList(a.email):b.getElementById("speakerQueue").appendChild(d.panel.createSpeakerNode(a,c,d.panel.speakerLive)),u.length>0?(p.style.display="",b.getElementById("queuedSpeakers").innerHTML=u.length):0===u.length&&(p.style.display="none")},upNextSpeaker:function(a,c){b.getElementById("upNext").appendChild(d.panel.createSpeakerNode(a,c,d.panel.speakerLive)),d.panel.removeSpeakerFromList(a.email),b.getElementById("queuedSpeakers").innerHTML=u.length},speakerLive:function(a,c){a.name=a.name||a.FirstName+" "+a.Surname;var e=b.getElementById("currentSpeaker");e.innerHTML="",e.appendChild(d.panel.createSpeakerNode(a,c,d.panel.removeSpeakerFromLive)),d.panel.removeSpeakerFromList(a.email),o="activeOptions:null,null,"+a.name+","+c,d.panel.resetAllVotes();var f=a.twitter,g='<span class="tweet-button"><a href="https://twitter.com/'+f+'" target="_blank"><i class="pictogram">&#62217;</i></a></span>';f||(g=""),d.panel.connect(o),d.panel.sendMarkup('<span class="currently-speaking">Currently Speaking:</span><span class="speaker-name">'+a.name+"</span>"+g),b.getElementById("queuedSpeakers").innerHTML=u.length},removeSpeakerFromList:function(a){for(var c=!1,e=0;e<u.length;e++)u[e].speaker.email===a&&(u.splice(e,1),c=!0);if(c){b.getElementById("speakerQueue").innerHTML="";for(var f=u.length,g=0;f>g;g++)d.panel.queueSpeaker(u[g].speaker,u[g].ip,!0)}},clearQueue:function(){u=[],p.style.display="none",b.getElementById("speakerQueue").innerHTML="",d.panel.resetAllVotes(),o="activeOptions:null,null,Discussion",d.panel.connect(o),b.getElementById("queuedSpeakers").innerHTML=u.length},removeSpeakerFromLive:function(){d.panel.resetAllVotes(),b.getElementById("currentSpeaker").innerHTML="Discussion",d.panel.sendMarkup("<b>Panel Discussion</b>"),o="activeOptions:null,null,Discussion",d.panel.connect(o)},resetAllVotes:function(){x.agree=0,x.disagree=0,d.panel.drawSentimentChart(),v=[],d.panel.setFloorTime()},resetContinuousFloorTime:function(){},drawSentimentChart:function(){var a=b.getElementById("sentiment-chart-agree"),c=b.getElementById("sentiment-chart-disagree"),d=b.getElementById("agreeCount"),e=b.getElementById("disagreeCount");if(0===x.agree&&0===x.disagree)a.style.width="10%",c.style.width="10%";else{var f=x.agree/(x.agree+x.disagree),g=x.disagree/(x.agree+x.disagree);a.style.width=100*f+"%",c.style.width=100*g+"%"}x.agree!==parseInt(d.innerHTML,10)&&(d.innerHTML=x.agree,d.className="bump-out",setTimeout(function(){d.className="bump-in"},200)),x.disagree!==parseInt(e.innerHTML,10)&&(e.innerHTML=x.disagree,e.className="bump-out",setTimeout(function(){e.className="bump-in"},200))},wsCount:function(){return m},pollCount:function(){return n},sendMarkup:function(a){var b=a.replace(/'/g,"&#39;"),c=JSON.stringify({remoteMarkup:encodeURIComponent(b)});this.connect(c)},updateRemotes:function(){var a;a=q.length>=1?"activeOptions:"+q+","+s+":"+r:"activeOptions:null,null,"+s+":"+r,this.connect(a)},roulette:function(){this.connect("roulette")},optionVote:function(a){var b;b=q.indexOf(a),a in x?x[a]+=1:x[a]=1;for(var c=0;c<q.length;c++)x.hasOwnProperty(q[c])&&(t+=x[q[c]])},handleKeys:function(a){switch(a.keyCode){case 39:case 13:case 32:case 34:a.preventDefault();break;case 37:case 33:a.preventDefault();break;case 40:a.preventDefault();break;case 38:a.preventDefault();break;case 78:break;case 27:}}},d.html5e=d.prototype={supports_local_storage:function(){try{return"localStorage"in a&&null!==a.localStorage}catch(b){return!1}},supports_app_cache:function(){try{return"applicationCache"in a&&null!==a.applicationCache}catch(b){return!1}},supports_geolocation:function(){try{return"geolocation"in navigator&&null!==navigator.geolocation}catch(a){return!1}},supports_websocket:function(){try{return"WebSocket"in a&&null!==a.WebSocket}catch(b){return!1}},supports_orientation:function(){try{return"DeviceOrientationEvent"in a&&null!==a.DeviceOrientationEvent}catch(b){return!1}},supports_motion:function(){try{return"DeviceMotionEvent"in a&&null!==a.DeviceMotionEvent}catch(b){return!1}}},d.template=d.prototype={simple:function(a,c){var e={},f=/\W/.test(a)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):e[a]=e[a]||d.template.simple(b.getElementById(a).innerHTML);return c?f(c):f}},d}()}(window,document);