/*! onslyde - v0.0.1 - 2014-09-20
* Copyright (c) 2014 Wesley Hales; Licensed  */
!function(a,b,c){"use strict";a.onslyde=function(){var d,e=function(a){return d=a,new e.core.init},f={sessionID:0,mode:"default"},g={sessionID:0,mode:"default"},h=0;e.core=e.prototype={constructor:e,start:function(){try{d&&(f=null!==d.panel?d.panel:null,g=null!==d.panelRemote?d.panelRemote:null)}catch(a){}e.core.hideURLBar(),f&&f.sessionID&&(h=f.sessionID,e.panel.init()),g&&g.sessionID&&(h=g.sessionID)},hideURLBar:function(){setTimeout(a.scrollTo,0,0,1)},init:function(){return a.addEventListener("load",function(){e.core.start()},!1),e.core},ajax:function(b,c,d){function e(){return a.XMLHttpRequest?new XMLHttpRequest:a.ActiveXObject?new a.ActiveXObject("Microsoft.XMLHTTP"):void 0}function f(){4===g.readyState&&200===g.status&&c&&c(g.responseText,b)}var g=e();g.onreadystatechange=f,this.doGet=function(){g.open("GET",b,d),g.send(null)},this.doPost=function(a){g.open("POST",b,d),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send(a)}}},e.core.init.prototype=e.core;var i,j,k=null,l=!1;e.ws=e.prototype={ip:function(a){var b;b=location.host.indexOf("onslyde.com")>=0?"https://www.onslyde.com:8443":"https://127.0.0.1:8443";new e.core.ajax(b+"/go/presenters/ip?session="+a,function(a){k="onslyde.com"===location.host?"www.onslyde.com":a},!1);return k=null===k&&"file:"!==location.protocol&&"localhost:8001"!==location.host?"www.onslyde.com":"www.onslyde.com"},getip:function(){var a,b=function(){return Math.floor(Math.random()*(d-c+1))+c},c=255,d=999;if(localStorage["onslyde.attendeeIP"])a=localStorage["onslyde.attendeeIP"];else{a=b()+"."+b()+"."+b()+"."+b();try{localStorage["onslyde.attendeeIP"]=a}catch(e){}}return a},sessionID:function(){return h},connect:function(a,b,c){if(j="anonymous",a)this.getip(),i=a;else{k||(k=this.ip(c));var d="wss://"+k+"/ws/?session="+c+"&attendeeIP="+this.getip();i=new WebSocket(d)}return i.onopen=function(){l=!0,"undefined"!=typeof b&&e.ws._send(b)},i.onmessage=this._onmessage,i.onclose=this._onclose,i.sendText=function(a){e.ws._send(a)},i},_onmessage:function(a){if(a.data)if("object"==typeof a.data)0!==a.data.onslydeEvent.sessionID&&a.data.onslydeEvent.fire();else if(a.data.indexOf('sessionID":"'+h)>0)try{var b=a.data;b=new Function("return "+b)(),b.onslydeEvent.fire()}catch(c){console.log(c)}},_onclose:function(){console.log("close it"),i=null},_onerror:function(){},_send:function(a){!i||i&&3===i.readyState?(console.log("connection closed... attempting reconnect"),this.connect(null,a,h)):i.send(a)}};var m,n,o,p,q,r,s=[],t=0,u=0,v=0,w=[],x=[],y=!0,z={agree:0,disagree:0},A=!1,B=-1,C=-1,D=b.querySelector("#continuousfloortime > span"),E=b.querySelector("#totalfloortime > span"),F=b.querySelector("#contributions > span"),G=b.getElementById("giveway"),H=null,I={};return e.panel=e.prototype={init:function(){function c(a){var c=b.getElementById(a);z[a]++,x.push({time:new Date,type:a}),e.panel.drawSentimentChart(),c&&(c.className="show-"+a+" transition",setTimeout(function(){c.className="hide-"+a+" transition"},800))}function d(a){for(var b=0;b<x.length;b++)a-x[b].time>15e3&&(z[x[b].type]--,x.splice(b,1),e.panel.drawSentimentChart())}a.addEventListener("clientVote",function(a){e.panel.optionVote(a.vote,m)},!1),a.addEventListener("updateCount",function(a){e.panel.updateDeck(a.wsCount,a.pollCount)},!1),a.addEventListener("speak",function(a){var b=JSON.parse(a.attendee);try{""!==b.name&&e.panel.queueSpeaker(b,a.ip)}catch(c){console.log("problem queueing speaker:",c)}},!1),a.addEventListener("disagree",function(){c("disagree")},!1),a.addEventListener("agree",function(){c("agree")},!1),a.addEventListener("questionToggle",function(){e.panel.questionToggle()},!1),a.addEventListener("questionIndex",function(a){C=B,console.log("cqi",B),B=a.index||"-1",B=parseInt(B,10),e.panel.questionIndex(B)},!1);var f=b.getElementById("timer"),g=new Date;setInterval(function(){var a=new Date;y&&d(a),f.innerHTML=e.panel.countUpTimer(a-g)},1e3),p="activeOptions:null,null,Discussion",this.connect("::connect::"),setTimeout(function(){e.panel.updateRemotes()},1e3),b.getElementById("sessionID").innerHTML=this.calculateConnectString(h),q=b.querySelector(".queue-title"),q.style.display="none",this.drawSentimentChart()},countUpTimer:function(a,b){b&&(a+=1e3);var c=Math.floor(a/36e5),d=Math.floor(a%36e5/6e4),e=Math.floor(a%36e5%6e4/1e3);return c=(10>c?"0":"")+c,d=(10>d?"0":"")+d,e=(10>e?"0":"")+e,c+":"+d+":"+e},setFloorTime:function(){H&&clearInterval(H);var a=new Date,b=0;H=setInterval(function(){var c=new Date;D.innerHTML=e.panel.countUpTimer(c-a),b++,D.style.color=b>60?"#FF99A0":"",G.style.display=b>120?"inline-block":"none"},1e3)},setTotalFloorTime:function(a){if(r&&clearInterval(r),!I[a]){var b=Date.parse("Thu, 01 Jan 1970 00:00:00 GMT");I[a]={start:b,contributions:0}}F.innerHTML=I[a].contributions++,r=setInterval(function(){var b=e.panel.countUpTimer(I[a].start,!0);E.innerHTML=b,I[a].start=Date.parse("Thu, 01 Jan 1970 "+b+" GMT")},1e3)},calculateConnectString:function(a){for(var b=["x","b","z","d","y","f","r","h","s","j"],c=a.toString().split(""),d="",e=0;e<c.length;e++)d+=b[c[e]];return d},connect:function(a){try{i?e.ws._send(a,h):e.ws.connect(null,a,h)}catch(b){console.log("error",b)}},questionToggle:function(){},questionIndex:function(){for(var a=b.querySelectorAll("#question-container li"),c=0;c<a.length;c++)console.log(B,C),B!==C?(a[c].style.maxHeight=c===B?"200px":"0px",a[c].style.opacity=c===B?1:0):(console.log(a[c].style.maxHeight),"0px"!==a[c].style.maxHeight&&c===B?(a[c].style.maxHeight="0px",a[c].style.opacity=0):c===B&&(a[c].style.maxHeight="200px",a[c].style.opacity=1))},toggleConnectInfo:function(){A?(b.getElementById("panel-container").className="",b.getElementById("modal").className="",A=!1):(b.getElementById("panel-container").className="blur",b.getElementById("modal").className="visible",b.getElementById("modal-connect-string").innerHTML=b.querySelector(".connect-url").innerHTML,A=!0)},toggleRollingAverage:function(){y=!y,y?(b.querySelector(".sentiment-bar1").style.borderRightColor="#777",b.querySelector(".sentiment-bar2").style.borderLeftColor="#777"):(b.querySelector(".sentiment-bar1").style.borderRightColor="#000",b.querySelector(".sentiment-bar2").style.borderLeftColor="#000")},updateDeck:function(a,c){var d=b.getElementById("totalCount");n=a,o=c,d.innerHTML=parseInt(a,10)+parseInt(c,10)},createSpeakerNode:function(a,d,e){a.name=a.name||a.FirstName+" "+a.Surname;var f=b.createDocumentFragment();f.appendChild(b.getElementById("speaker-template").cloneNode(!0));var g=f.querySelector("img");g.src=a.pic,g.onclick=function(){e(a,d)},f.querySelector(".name").innerHTML=a.name;try{var h=getAttendees();if("[object Array]"===Object.prototype.toString.call(h))for(var i=0,j=h.length;j>i;i++){var k=h[i],l=k.FirstName+" "+k.Surname;if(a.name===l){a.org=k.Company;break}if(a.email===k.Email){a.org=k.Company;break}a.org=""}}catch(m){console.log("fix this")}return a.org!==c&&(f.querySelector(".org").innerHTML=a.org),f},queueSpeaker:function(a,c,d){var f=!1;if(!d){for(var g=0,h=w.length;h>g;g++)if(w[g].speaker.email===a.email){f=!0;break}f||w.push({speaker:a,ip:c})}f?e.panel.removeSpeakerFromList(a.email):b.getElementById("speakerQueue").appendChild(e.panel.createSpeakerNode(a,c,e.panel.speakerLive)),w.length>0?(q.style.display="",b.getElementById("queuedSpeakers").innerHTML=w.length):0===w.length&&(q.style.display="none")},upNextSpeaker:function(a,c){b.getElementById("upNext").appendChild(e.panel.createSpeakerNode(a,c,e.panel.speakerLive)),e.panel.removeSpeakerFromList(a.email),b.getElementById("queuedSpeakers").innerHTML=w.length},speakerLive:function(a,c){a.name=a.name||a.FirstName+" "+a.Surname;var d=b.getElementById("currentSpeaker");d.innerHTML="",e.panel.setTotalFloorTime(c),d.appendChild(e.panel.createSpeakerNode(a,c,e.panel.removeSpeakerFromLive)),e.panel.removeSpeakerFromList(a.email),p="activeOptions:null,null,"+a.name+","+c,e.panel.resetAllVotes();var f=a.twitter,g='<span class="tweet-button"><a href="https://twitter.com/'+f+'" target="_blank"><i class="pictogram">&#62217;</i></a></span>';f||(g=""),e.panel.connect(p),e.panel.sendMarkup('<span class="currently-speaking">Currently Speaking:</span><span class="speaker-name">'+a.name+"</span>"+g),b.getElementById("queuedSpeakers").innerHTML=w.length},removeSpeakerFromList:function(a){for(var c=!1,d=0;d<w.length;d++)w[d].speaker.email===a&&(w.splice(d,1),c=!0);if(c){b.getElementById("speakerQueue").innerHTML="";for(var f=w.length,g=0;f>g;g++)e.panel.queueSpeaker(w[g].speaker,w[g].ip,!0)}},clearQueue:function(){w=[],q.style.display="none",b.getElementById("speakerQueue").innerHTML="",e.panel.resetAllVotes(),p="activeOptions:null,null,Discussion",e.panel.connect(p),b.getElementById("queuedSpeakers").innerHTML=w.length},removeSpeakerFromLive:function(){e.panel.resetAllVotes(),b.getElementById("currentSpeaker").innerHTML="Discussion",e.panel.sendMarkup("<b>Panel Discussion</b>"),p="activeOptions:null,null,Discussion",e.panel.connect(p)},resetAllVotes:function(){z.agree=0,z.disagree=0,e.panel.drawSentimentChart(),x=[],e.panel.setFloorTime()},resetContinuousFloorTime:function(){},drawSentimentChart:function(){var a=b.getElementById("sentiment-chart-agree"),c=b.getElementById("sentiment-chart-disagree"),d=b.getElementById("agreeCount"),e=b.getElementById("disagreeCount");if(0===z.agree&&0===z.disagree)a.style.width="10%",c.style.width="10%";else{var f=z.agree/(z.agree+z.disagree),g=z.disagree/(z.agree+z.disagree);a.style.width=100*f+"%",c.style.width=100*g+"%"}z.agree!==parseInt(d.innerHTML,10)&&(d.innerHTML=z.agree,d.className="bump-out",setTimeout(function(){d.className="bump-in"},200)),z.disagree!==parseInt(e.innerHTML,10)&&(e.innerHTML=z.disagree,e.className="bump-out",setTimeout(function(){e.className="bump-in"},200))},wsCount:function(){return n},pollCount:function(){return o},sendMarkup:function(a){var b=a.replace(/'/g,"&#39;"),c=JSON.stringify({remoteMarkup:encodeURIComponent(b)});this.connect(c)},updateRemotes:function(){var a;a=s.length>=1?"activeOptions:"+s+","+u+":"+t:"activeOptions:null,null,"+u+":"+t,this.connect(a)},roulette:function(){this.connect("roulette")},optionVote:function(a){var b;b=s.indexOf(a),a in z?z[a]+=1:z[a]=1;for(var c=0;c<s.length;c++)z.hasOwnProperty(s[c])&&(v+=z[s[c]])},handleKeys:function(a){switch(a.keyCode){case 39:case 13:case 32:case 34:a.preventDefault();break;case 37:case 33:a.preventDefault();break;case 40:a.preventDefault();break;case 38:a.preventDefault();break;case 78:break;case 27:}}},e.html5e=e.prototype={supports_local_storage:function(){try{return"localStorage"in a&&null!==a.localStorage}catch(b){return!1}},supports_app_cache:function(){try{return"applicationCache"in a&&null!==a.applicationCache}catch(b){return!1}},supports_geolocation:function(){try{return"geolocation"in navigator&&null!==navigator.geolocation}catch(a){return!1}},supports_websocket:function(){try{return"WebSocket"in a&&null!==a.WebSocket}catch(b){return!1}},supports_orientation:function(){try{return"DeviceOrientationEvent"in a&&null!==a.DeviceOrientationEvent}catch(b){return!1}},supports_motion:function(){try{return"DeviceMotionEvent"in a&&null!==a.DeviceMotionEvent}catch(b){return!1}}},e.template=e.prototype={simple:function(a,c){var d={},f=/\W/.test(a)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+a.replace(/[\r\t\n]/g," ").split("<%").join("	").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("	").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"):d[a]=d[a]||e.template.simple(b.getElementById(a).innerHTML);return c?f(c):f}},e}()}(window,document);